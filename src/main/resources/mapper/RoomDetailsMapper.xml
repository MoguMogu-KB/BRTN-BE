<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.backend.roomdetails.mapper.RoomDetailsMapper">
    <resultMap id="MyRoomResultMap" type="RoomListVO">
        <result property="roomNum" column="roomNum"/>
        <result property="accountNumber" column="accountNumber"/>
        <result property="title" column="title"/>
        <result property="category" column="category"/>
        <result property="period" column="period"/>
        <result property="role" column="role"/>
        <result property="memberCurrent" column="memberCurrent"/>
    </resultMap>

    <!-- 1. 참여자 목록 조회 -->
    <select id="getParticipantsByRoomId" parameterType="int" resultType="UserVO">
        SELECT u.userId, u.name, u.gender,u.age
        FROM PersonList p
                 JOIN User u ON p.UserId = u.UserId
        WHERE p.roomNum = #{roomNum}
    </select>

    <!-- 2. 회비 제출 날짜 조회 -->
    <select id="getDueDateByRoomId" parameterType="int" resultType="Date">
        SELECT dueDate FROM RoomList WHERE roomNum = #{roomNum}
    </select>

    <!-- 3. 모임통장 거래 내역 조회 -->
    <select id="getTransactionHistory" parameterType="String" resultType="com.example.backend.roomdetails.vo.Transaction">
        SELECT * FROM Transaction WHERE accountNumber = #{accountNumber} ORDER BY time
    </select>

    <!-- 4. 구독 계정 정보 조회 (모든 인원이 모였을 때) -->
    <select id="getSubscriptionAccount" parameterType="int" resultType="String">
        SELECT subscriptionAccount FROM RoomComplete WHERE roomNum = #{roomNum}
    </select>

    <!-- 22. 비밀번호 랜덤 값 생성 -->
    <select id="randomPassword" resultType="string">
        SELECT CONCAT(
                    SUBSTRING('ABCDEFGHIJKLMNOPQRSTUVWXYZ', FLOOR(1 + (RAND() * 26)), 1),
                    SUBSTRING('abcdefghijklmnopqrstuvwxyz', FLOOR(1 + (RAND() * 26)), 1),
                    SUBSTRING('0123456789', FLOOR(1 + (RAND() * 10)), 1),
                    SUBSTRING('!@#$%^*()', FLOOR(1 + (RAND() * 10)), 1),
                    SUBSTRING('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^*()', FLOOR(1 + (RAND() * 70)), 1),
                    SUBSTRING('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^*()', FLOOR(1 + (RAND() * 70)), 1),
                    SUBSTRING('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^*()', FLOOR(1 + (RAND() * 70)), 1),
                    SUBSTRING('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^*()', FLOOR(1 + (RAND() * 70)), 1)
        ) AS random_password;
    </select>

    <!-- 27. 내가 참여 중인 방 목록 출력 -->
    <select id="selectMyRoomList" parameterType="string" resultMap="MyRoomResultMap">
        SELECT rl.roomNum, rl.accountNumber, rl.title, rl.category, rl.period, pl.role, rc.memberCurrent
        FROM RoomList rl
                 LEFT JOIN PersonList pl ON rl.roomNum = pl.roomNum
                 LEFT JOIN RoomComplete rc ON rl.roomNum = rc.roomNum
        WHERE pl.id = #{id};
    </select>
</mapper>